// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}
model Board {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  userId      String   // Owner - Clerk user ID
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lists      List[]
  activities Activity[]
  members    BoardMember[] // Add this

  @@index([userId])
}

model BoardMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  boardId   String   @db.ObjectId
  userId    String   // Clerk user ID
  userName  String
  userEmail String
  userImage String?
  role      MemberRole @default(MEMBER)
  addedAt   DateTime @default(now())

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
}
model BoardReport {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  boardId           String   @db.ObjectId
  reportDate        DateTime @default(now())
  totalLists        Int
  totalCards        Int
  completedCards    Int
  inProgressCards   Int
  overdueCards      Int
  cardsCreatedToday Int
  cardsCompletedToday Int
  activeMembers     Int
  averageCardAge    Float    // in days
  velocityScore     Int      // Cards completed per week
  metrics           Json     // Additional metrics
  createdAt         DateTime @default(now())

  @@index([boardId])
  @@index([reportDate])
}
model Checklist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  cardId    String   @db.ObjectId
  title     String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  card  Card           @relation(fields: [cardId], references: [id], onDelete: Cascade)
  items ChecklistItem[]

  @@index([cardId])
}

model ChecklistItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  checklistId String   @db.ObjectId
  title       String
  completed   Boolean  @default(false)
  order       Int
  assigneeId  String?  // Clerk user ID
  assigneeName String?
  assigneeImage String?
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  checklist Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId])
}
model List {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  order     Int
  boardId   String   @db.ObjectId
  isCompleted Boolean @default(false) // Add this to mark "Done" lists
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards Card[]

  @@index([boardId])
}
model Card {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  order       Int
  listId      String    @db.ObjectId
  priority    Priority  @default(MEDIUM)
  dueDate     DateTime?
  completedAt DateTime?
  estimatedHours Float?
  actualHours Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  list        List           @relation(fields: [listId], references: [id], onDelete: Cascade)
  comments    Comment[]
  attachments Attachment[]
  activities  Activity[]
  assignees   CardAssignee[]
  checklists  Checklist[]
  links       CardLink[]

  @@index([listId])
  @@index([completedAt])
}

model CardAssignee {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  cardId    String   @db.ObjectId
  userId    String   // Clerk user ID
  userName  String
  userEmail String
  userImage String?
  assignedAt DateTime @default(now())

  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([cardId, userId])
  @@index([cardId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  userId    String   // Clerk user ID
  userName  String   // Cached from Clerk
  userImage String?  // Cached from Clerk
  cardId    String   @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model Attachment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  url       String
  size      Int      // in bytes
  type      String   // MIME type
  cardId    String   @db.ObjectId
  userId    String   // Clerk user ID who uploaded
  createdAt DateTime @default(now())

  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

model Activity {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  action    ActivityType
  entityId  String       @db.ObjectId // ID of the card, list, or board affected
  entityType EntityType
  userId    String       // Clerk user ID
  userName  String       // Cached from Clerk
  userImage String?      // Cached from Clerk
  boardId   String?      @db.ObjectId
  cardId    String?      @db.ObjectId
  metadata  Json?        // Additional data (e.g., old/new values)
  createdAt DateTime     @default(now())

  board Board? @relation(fields: [boardId], references: [id], onDelete: Cascade)
  card  Card?  @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@index([cardId])
  @@index([entityId])
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  CREATED
  UPDATED
  DELETED
  MOVED
  COMMENTED
  ATTACHMENT_ADDED
}

enum EntityType {
  BOARD
  LIST
  CARD
  COMMENT
}
model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Integration {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   // Clerk user ID
  type        String   // "google_drive", "slack", "jira"
  accessToken String?
  refreshToken String?
  metadata    Json?    // Additional integration-specific data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([type])
}
model CardLink {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  cardId    String   @db.ObjectId
  title     String
  url       String
  createdAt DateTime @default(now())

  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}
model WorkloadSnapshot {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   // Clerk user ID
  userName      String
  boardId       String   @db.ObjectId
  totalCards    Int
  completedCards Int
  inProgressCards Int
  overdueCards  Int
  upcomingCards Int
  averageCompletionTime Float? // in hours
  workloadScore Int      // 0-100, higher means more overloaded
  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([boardId])
  @@index([timestamp])
}